<!DOCTYPE html>
<html lang='en'>
  <head>
    <title>GA Movies</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css'>
  </head>
  <body>
    <div id='content'></div>

    <script type='text/jsx'>
      var Container = React.createClass({
        handleSearchSubmit: function(search){
          // Need to get title in the form of 'Star+Wars' for 'Star Wars' for OMBD API
          var title = search.title.split(' ').join('+');

          // Do a search request to OMBD for movies matching the title
          $.ajax({
            type: 'GET',
            url: '//www.omdbapi.com/?s='+title+'&r=json',
            async: false,
            jsonpCallback: 'jsonCallback',
            contentType: 'application/json',
            dataType: 'jsonp',
            success: function(data) {
              if(data.Search) {
                $("#searchPlaceholder").hide();
                // OMDB API returns {Search: [{...}]} on successful search
                this.setState({searchData: data.Search});
                return;
              }
              // OMDB API returns {Response: 'False', Error: 'Movie not found!'}
              // when search is unsuccessful. Poor API conventions.
              this.setState({data: {error: data.Error}});
            }.bind(this),
            error: function(e) {
               console.log('error', e.responseText);
            }
          });
        },
        fetchFavorites: function() {
          $.ajax({
            type: 'GET',
            url: '/favorites',
            contentType: 'application/json',
            dataType: 'json',
            success: function(data) {
              $("#favoritesPlaceholder").hide();
              this.setState({favoritesData: data});
            }.bind(this),
            error: function(e) {
              console.log('error', e);
            }
          });
        },
        getInitialState: function() {
          return {
            searchData: [],
            favoritesData: []
          };
        },
        componentDidMount: function() {
          this.fetchFavorites();
        },
        render: function() {
          return (
            <div className='container'>
              <nav className="navbar navbar-inverse">
                <div className="container-fluid">
                  <div className="navbar-header">
                    <a className="navbar-brand" href="/">Movie Search</a>
                  </div>
                  <SearchForm onSearchSubmit={this.handleSearchSubmit} />
                </div>
              </nav>
              <ul className="nav nav-tabs" role="tablist">
                <li role="presentation" className="active"><a href="#search" aria-controls="home" role="tab" data-toggle="tab">Search</a></li>
                <li role="presentation"><a href="#favorites" aria-controls="profile" role="tab" data-toggle="tab" onClick={this.fetchFavorites}>Favorites</a></li>
              </ul>
              <div className="tab-content">
                <div role="tabpanel" className="tab-pane active" id="search">
                  <MovieList data={this.state.searchData} />
                  <h3 id="searchPlaceholder">Search For Some Movies!</h3>
                </div>
                <div role="tabpanel" className="tab-pane" id="favorites">
                  <MovieList data={this.state.favoritesData} />
                  <h3 id="favoritesPlaceholder">Favorite Some Movies!</h3>
                </div>
              </div>
            </div>
          );
        }
      });
      var MovieList = React.createClass({
        render: function() {
          if(!this.props.data.error) {
            var movieNodes = this.props.data.map(function (movie, index) {
              return (
                <Movie title={movie.Title} id={movie.imdbID} key={index} />
              );
            });
            return (
              <ul className='movieList list-group'>
                {movieNodes}
              </ul>
            );
          }
          return (
            <h2>No Results Found!</h2>
          );
        }
      });
      var Movie = React.createClass({
        fetchMovieDetails: function(id) {
          // Fetch movie details
          var callback = 'c'+Math.floor((Math.random()*100000000)+1);
          $.ajax({
            type: 'GET',
            url: '//www.omdbapi.com/?i='+id+'&y=&plot=short&r=json?',
            async: false,
            jsonpCallback: callback,
            contentType: 'application/json',
            dataType: 'jsonp',
            success: function(data) {
              // When data is ready update state to rerender MovieDetails template
              this.setState({detailData: data});
            }.bind(this),
            error: function(e) {
               console.log('error', e);
            }
          });
        },
        getInitialState: function () {
          return {detailData: []};
        },
        componentDidMount: function() {
          this.fetchMovieDetails(this.props.id);
        },
        render: function() {
          return (
            <li className='movie list-group-item'>
              <a href={'#'+this.props.id} className='movieTitle' data-toggle='collapse'>
                <h4>{this.props.title}</h4>
              </a>
              <MovieDetails detailData={this.state.detailData} />
            </li>
          );
        }
      });
      var MovieDetails = React.createClass({
        handleFavorite: function() {
          $.ajax({
            type: "POST",
            url: "/favorites",
            data: this.props.detailData,
            dataType: "json",
            success: function(data) {
              $(".favorite#"+this.props.detailData.imdbID).addClass("active");
            }.bind(this),
            error: function(e) {
              console.log("error", e.responseText);
            }
          });
        },
        render: function() {
          return (
            <div className='movieDetail collapse' id={this.props.detailData.imdbID}>
              <div className='row'>
                <div className='col-sm-4'>
                  <img src={this.props.detailData.Poster} />
                </div>
                <div className='col-sm-8'>
                  <div className='row'>
                    <a href="#" className="btn btn-warning favorite" id={this.props.detailData.imdbID} onClick={this.handleFavorite} >
                      <span className="glyphicon glyphicon-star" aria-hidden="true"></span> Favorite
                    </a>
                  </div>
                  <div className='row'>
                    <h4>
                      IMDB Rating: <small>{this.props.detailData.imdbRating} from {this.props.detailData.imdbVotes} votes</small>
                    </h4>
                  </div>
                  <p className='row'>{this.props.detailData.Plot}</p>
                </div>
              </div>

            </div>
          );
        }
      });
      var SearchForm = React.createClass({
        handleSubmit: function(e) {
          e.preventDefault();
          var title = React.findDOMNode(this.refs.title).value.trim();
          if(!title) {
            return;
          }
          this.props.onSearchSubmit({title: title});
          React.findDOMNode(this.refs.title).value = '';
          return;
        },
        render: function() {
          return (
            <form className="searchForm navbar-form navbar-right" role="search">
              <div className='form-group'>
                <input type='text' className='form-control' placeholder='Search for a movie' ref='title' />
              </div>
              <a role='button' className='btn btn-primary' onClick={this.handleSubmit}>Search</a>
            </form>
          );
        }
      });

      React.render(
        <Container />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
